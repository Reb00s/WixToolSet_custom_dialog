<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <?if $(var.Platform)=x64?>
  <?define ProductCode="{E50597DA-F608-4D75-AB94-29A0267994E3}"?>
  <?else?>
  <?define ProductCode="{990D633A-6B46-4FE2-B455-FEFCBC78C794}"?>
  <?endif?>

  <?define ProductName="ARMA 187 (Server)"?>
  <?define Description="InfoWatch ARMA 187 Server"?>

  <?define BuildVersion=1.0.0.55?>
  <?define Manufacturer=InfoWatch ARMA?>

	<Product Id="$(var.ProductCode)"
	         Name="$(var.ProductName)"
	         Codepage="1251"
	         Language="1049"
	         Version="$(var.BuildVersion)"
	         Manufacturer="$(var.Manufacturer)"
	         UpgradeCode="DB645A0F-D192-4656-AC7B-BAC963384603">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

	  <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
	  <MediaTemplate EmbedCab="yes" />

	  <Icon Id="AppIcon" SourceFile="Logo_ARMA_187_clear.ico"/>
	  <Property Id="ARPPRODUCTICON" Value="AppIcon"/>

	  <WixVariable Id="WixUILicenseRtf" Overridable="yes" Value="EULA-RU.rtf"/>
	  <Property Id="WIXUI_INSTALLDIR" Value="INSTALLLOCATION"/>
	  <UIRef Id="MyWixUI_InstallDir"/>

	  <WixVariable Id="WixUIBannerBmp" Value="Banner.bmp" />
	  <WixVariable Id="WixUIDialogBmp" Value="Dialog.bmp" />
    
	  <!-- Require .NET 4.6+ -->
	  <PropertyRef Id="WIX_IS_NETFRAMEWORK_46_OR_LATER_INSTALLED"/>
	  <Condition Message="!(loc.NetRequired)">
	    <![CDATA[Installed OR WIX_IS_NETFRAMEWORK_46_OR_LATER_INSTALLED]]>
	  </Condition>

	  <!--<CustomAction Id="LunchInstalledExe" Directory="INSTALLFOLDER" Execute="immediate" Impersonate="yes" Return="asyncNoWait" ExeCommand="[#$(var.TargetFileName]"/>-->

	  <!--<InstallExecuteSequence>
      <Custom Action="LaunchInstalledExe" After="InstallFinalize"/>
    </InstallExecuteSequence>-->
	  <Property Id="ApplicationFolderName" Value="My Application Folder" />
	  <Property Id="WixAppFolder" Value="WixPerMachineFolder" />
	  
    <Property Id="ProperSaPassword" Value="sasasasa"  />
	<Property Id="ProperRootPassword" Value="rootroot" />
    
	<Feature Id="ProductFeature" Title="Arma187.server" Level="1">
	    <ComponentGroupRef Id="ProductComponents" />
	    <ComponentRef Id="InstallDirComponent"/>
	    <ComponentRef Id="arma187_Component"/>
	    <ComponentRef Id="create_root_Component"/>
	    <ComponentRef Id="drop_database_Component"/>
    </Feature>

	  <!-- Find sqlcmd.exe path  -->
	  <Property Id="SQLBINDIR">
	    <RegistrySearch Id="SqlBinDir"
	                    Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\130\Tools\ClientSetup"
	                    Name="Path"
	                    Type="raw" />
	  </Property>
    
    <!--INSTALL SERVER-->
    <!--<CustomAction Id="LoadServerSource" Directory="INSTALLLOCATION" ExeCommand="[INSTALLLOCATION]SQLServer2016-SSEI-Expr.exe /ACTION=Download MEDIAPATH=[INSTALLLOCATION] /MEDIATYPE=Core /QUIET" Execute="deferred" Impersonate="no"  Return="check"/>
	  <CustomAction Id="UnpackServerSource" Directory="INSTALLLOCATION" ExeCommand="[INSTALLLOCATION]SQLEXPR_x64_ENU.exe /q /x:[INSTALLLOCATION]SQLEXPR_2016\" Execute="deferred" Impersonate="no"  Return="check"/>
	  <CustomAction Id="ServerSetSQLSYSADMINACCOUNTS" Directory="INSTALLLOCATION" ExeCommand="cmd.exe /c &quot;echo SQLSYSADMINACCOUNTS=&quot;%computername%\%username%&quot; >> [INSTALLLOCATION]ConfigurationFile.ini&quot;" Execute="deferred" Impersonate="no"  Return="check"/>
	  <CustomAction Id="ServerSetSAPWD" Directory="INSTALLLOCATION" ExeCommand="cmd.exe /c &quot;echo SAPWD=&quot;[ProperSaPassword]&quot; >> [INSTALLLOCATION]ConfigurationFile.ini&quot;" Execute="deferred" Impersonate="no"  Return="check"/>-->

	  <!--<CustomAction Id="ServerInstall" Directory="INSTALLLOCATION" ExeCommand="cmd.exe /c &quot;cmd.exe&quot;" Execute="deferred" Impersonate="no"  Return="check"/> --><!--/ConfigurationFile=[INSTALLLOCATION]ConfigurationFile.ini [INSTALLLOCATION]PsExec.exe -i -s [INSTALLLOCATION]SQLEXPR_2016\SETUP.EXE /ACTION=Install /SkipRules=HasSecurityBackupAndDebugPrivilegesCheck-->

    <!--<CustomAction Id="ServerSetGrant" Directory="INSTALLLOCATION" ExeCommand="cmd.exe /c &quot;icacls [INSTALLLOCATION]arma187.bak /grant *S-1-1-0:F&quot;" Execute="deferred" Impersonate="no"  Return="check"/>-->
	  <!--<CustomAction Id="ServerRestoreDb" Directory="INSTALLLOCATION" ExeCommand="&quot;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\130\Tools\Binn\SQLCMD.EXE&quot; -S %computername%\SQLEXPRESS -U sa -P &quot;[ProperSaPassword]&quot; -Q &quot;RESTORE DATABASE arma187 FROM DISK=N'[INSTALLLOCATION]arma187.bak'&quot;" Execute="immediate" Impersonate="yes"  Return="check"/>
	  <CustomAction Id="ServerCreateRoot" Directory="INSTALLLOCATION" ExeCommand="&quot;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\130\Tools\Binn\SQLCMD.EXE&quot; -S %computername%\SQLEXPRESS -U sa -P &quot;[ProperSaPassword]&quot; -i &quot;[INSTALLLOCATION]create_root.sql&quot;" Execute="immediate" Impersonate="yes"  Return="check"/>
	  <CustomAction Id="ServerSetRootPwd" Directory="INSTALLLOCATION" ExeCommand="&quot;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\130\Tools\Binn\SQLCMD.EXE&quot; -S %computername%\SQLEXPRESS -U sa -P &quot;[ProperSaPassword]&quot; -Q &quot;alter login root with password=N'[ProperRootPassword]'&quot;" Execute="immediate" Impersonate="yes"  Return="check"/>
	  <CustomAction Id="SetTcpPort" Directory="INSTALLLOCATION" ExeCommand="cmd.exe /c &quot;reg add 'HKLM\Software\Microsoft\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQLServer\SuperSocketNetLib\Tcp\IPAll\' /v TcpPort /t REG_SZ /d 1433 /f" Execute="deferred" Impersonate="no"  Return="check"/>-->


     <!--Need to use "property" CA to get variable substitution--> 
	  <CustomAction Id="ServerRestoreDb"
	                Property="sqlcmd"
	                Value="sqlcmd.exe -S .\SQLEXPRESS -Q &quot;RESTORE DATABASE arma187 FROM DISK=N'[INSTALLLOCATION]arma187.bak'&quot; -U sa -P &quot;[ProperSaPassword]&quot;" />
	  <CustomAction Id="ServerCreateRoot"
	                Property="sqlcmd"
	                Value="sqlcmd.exe -S .\SQLEXPRESS -i &quot;[INSTALLLOCATION]create_root.sql&quot; -U sa -P &quot;[ProperSaPassword]&quot;" />
	  <CustomAction Id="ServerSetRootPwd"
	                Property="sqlcmd"
	                Value="sqlcmd.exe -S .\SQLEXPRESS -Q &quot;alter login root with password='[ProperRootPassword]'&quot; -U sa -P &quot;[ProperSaPassword]&quot;" />

	  <!--<CustomAction Id="SetTcpPort" Directory="INSTALLLOCATION" ExeCommand="cmd.exe /c &quot;reg add 'HKLM\Software\Microsoft\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQLServer\SuperSocketNetLib\Tcp\IPAll\' /v TcpPort /t REG_SZ /d 1433 /f" Execute="deferred" Impersonate="no"  Return="check"/>-->

	  <!-- Note that the cmd line and args will come from a property with the same name as the CA, this has been set by the CA above -->
	  <CustomAction Id="sqlcmd"
	                BinaryKey="WixCA"
	                DllEntry="CAQuietExec"
	                Return="check"
	                Execute="deferred"
	                Impersonate="yes" />


    <InstallExecuteSequence>
	    <!--<Custom Action="LoadServerSource" After="InstallFiles">NOT Installed AND NOT REMOVE</Custom>
	    <Custom Action="UnpackServerSource" After="LoadServerSource">NOT Installed AND NOT REMOVE</Custom>
	    <Custom Action="ServerSetSQLSYSADMINACCOUNTS" After="UnpackServerSource">NOT Installed AND NOT REMOVE</Custom>
	    <Custom Action="ServerSetSAPWD" After="ServerSetSQLSYSADMINACCOUNTS">NOT Installed AND NOT REMOVE</Custom>
	    <Custom Action="ServerInstall" After="ServerSetSAPWD">NOT Installed AND NOT REMOVE</Custom>-->

	    <!--<Custom Action="ServerSetGrant" After="InstallFiles">NOT Installed AND NOT REMOVE</Custom>-->
	    <Custom Action="ServerRestoreDb" After="InstallFiles">NOT Installed AND NOT REMOVE</Custom>
	    <Custom Action="ServerCreateRoot" After="ServerRestoreDb">NOT Installed AND NOT REMOVE</Custom>
	    <Custom Action="ServerSetRootPwd" After="ServerCreateRoot">NOT Installed AND NOT REMOVE</Custom>
	    <!--<Custom Action="SetTcpPort" After="ServerSetRootPwd">NOT Installed AND NOT REMOVE</Custom>-->
	    <ScheduleReboot After="InstallFinalize"/>
	  </InstallExecuteSequence>

    <!--UNINSTALL SERVER-->
	  <CustomAction Id="ServerDropDb"
	                Property="sqlcmd"
	                Value="&quot;[SQLBINDIR]sqlcmd.exe&quot; -E -S .\SQLEXPRESS -i &quot;[INSTALLLOCATION]drop_database.sql&quot; -U sa -P &quot;[ProperSaPassword]&quot;" />

		<!--<CustomAction Id="ServerDropDb" Directory="INSTALLLOCATION" ExeCommand="&quot;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\130\Tools\Binn\SQLCMD.EXE&quot; -S %computername%\SQLEXPRESS -i &quot;[INSTALLLOCATION]drop_database.sql&quot;" Execute="deferred" Impersonate="no" Return="check"/>-->
	  <!--<CustomAction Id="ServerUninstall" Directory="INSTALLLOCATION" ExeCommand="[INSTALLLOCATION]SQLEXPR_2016\SETUP.EXE /ConfigurationFile=[INSTALLLOCATION]ConfigurationFileUninstall.ini" Execute="deferred" Impersonate="no" Return="check"/>
	  <CustomAction Id="ServerDeleteSource" Directory="INSTALLLOCATION" ExeCommand="rmdir /S /Q [INSTALLLOCATION]SQLEXPR_2016" Execute="deferred" Impersonate="no" Return="check"/>-->

		<InstallExecuteSequence>
		  <Custom Action="ServerDropDb" Before="RemoveFiles">Installed</Custom>
			<!--<Custom Action="ServerUninstall" After="ServerDropDb">Installed</Custom>
		  <Custom Action="ServerDeleteSource" After="ServerUninstall">Installed</Custom>-->
		</InstallExecuteSequence>

	</Product>

	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
		  <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLLOCATION" Name="Arma187.server">
				  <Component Id="InstallDirComponent" Guid="8EEBE7C0-A0A1-4CBA-85DD-ED2E7EA47874">
				    <CreateFolder>
				      <util:PermissionEx User="Users" GenericAll="yes" Read="yes" ReadAttributes="yes" CreateChild="yes" Delete="yes" DeleteChild="yes" WriteAttributes="yes"/>
				    </CreateFolder>
				  </Component>
			    <Component Id="arma187_Component" Guid="{073DDD0A-9F9F-4A47-9C8F-999C54F107D9}">
			      <File Id="arma187" Source="$(var.ProjectDir)source\arma187.bak" />
			    </Component>
			    <Component Id="create_root_Component" Guid="{B8D11BA5-401D-499A-AFC9-C0A7D154A770}">
			      <File Id="create_root" Source="$(var.ProjectDir)source\create_root.sql" />
			    </Component>
			    <Component Id="drop_database_Component" Guid="{AD2AE523-46C0-43FA-8C5F-EE518CBF5D71}">
			      <File Id="drop_database" Source="$(var.ProjectDir)source\drop_database.sql" />
			    </Component>
        </Directory>
			</Directory>
		</Directory>

	</Fragment>

	<Fragment>
		<ComponentGroup Id="ProductComponents" Directory="INSTALLLOCATION">
		</ComponentGroup>
	</Fragment>

  
</Wix>
